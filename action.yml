name: 'MemBrowse - Firmware Memory Tracking'
description: 'Track RAM and Flash usage across commits and PRs to catch memory regressions.'
author: 'MemBrowse'

inputs:
  elf:
    description: 'Path to ELF file'
    required: true
  ld:
    description: 'Space-separated list of linker script paths'
    required: true
  target_name:
    description: 'Target name like esp32, stm32f4'
    required: true
  api_key:
    description: 'API key for MemBrowse'
    required: false
  api_url:
    description: 'MemBrowse API base URL (/upload appended automatically)'
    required: false
    default: 'https://api.membrowse.com'
  dont_fail_on_alerts:
    description: 'Continue even if budget alerts are detected (default: fail on alerts)'
    required: false
    default: 'false'
  linker_vars:
    description: 'Space-separated linker variable definitions (e.g., "__micropy_flash_size__=4096K RAM_START=0x20000000")'
    required: false
    default: ''
  verbose:
    description: 'Enable verbose output including full API responses (default: WARNING)'
    required: false
    default: 'WARNING'
  pr_author_name:
    description: 'PR author name (auto-detected from GitHub event if not provided)'
    required: false
    default: ''
  pr_author_email:
    description: 'PR author email (auto-detected from GitHub event if not provided)'
    required: false
    default: ''

outputs:
  report_path:
    description: 'Path to the generated JSON report file'
    value: ${{ steps.analysis.outputs.report_path }}

runs:
  using: 'composite'
  steps:
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install membrowse package
      shell: bash
      run: |
        pip install ${{ github.action_path }}

    - name: Run memory analysis
      id: analysis
      shell: bash
      run: |
        set -o pipefail

        # Global args (before subcommand)
        GLOBAL_ARGS=()
        if [ "${{ inputs.verbose }}" != "WARNING" ]; then
          GLOBAL_ARGS+=(--verbose "${{ inputs.verbose }}")
        fi

        # Subcommand args
        ARGS=(
          "${{ inputs.elf }}"
          "${{ inputs.ld }}"
          --upload
          --github
          --target-name "${{ inputs.target_name }}"
          --api-key "${{ inputs.api_key }}"
        )

        # Only pass api-url if explicitly provided and non-empty
        if [ -n "${{ inputs.api_url }}" ]; then
          ARGS+=(--api-url "${{ inputs.api_url }}")
        fi

        if [ "${{ inputs.dont_fail_on_alerts }}" = "true" ]; then
          ARGS+=(--dont-fail-on-alerts)
        fi

        # Add linker variable definitions
        if [ -n "${{ inputs.linker_vars }}" ]; then
          for var in ${{ inputs.linker_vars }}; do
            ARGS+=(--def "$var")
          done
        fi

        # Add PR author info if provided
        if [ -n "${{ inputs.pr_author_name }}" ]; then
          ARGS+=(--pr-author-name "${{ inputs.pr_author_name }}")
        fi
        if [ -n "${{ inputs.pr_author_email }}" ]; then
          ARGS+=(--pr-author-email "${{ inputs.pr_author_email }}")
        fi

        # Run report command and save output to file
        REPORT_PATH="${{ runner.temp }}/membrowse_${{ inputs.target_name }}.json"
        membrowse "${GLOBAL_ARGS[@]}" report "${ARGS[@]}" --output-raw-response > "$REPORT_PATH"
        echo "report_path=$REPORT_PATH" >> "$GITHUB_OUTPUT"

branding:
  icon: 'bar-chart-2'
  color: 'blue'
